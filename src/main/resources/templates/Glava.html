<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
  <!-- Подключаем общий head из baza.html -->
  <th:block th:replace="baza :: links"></th:block>
</head>
<body>

<!-- Подключаем меню/навигацию -->
<th:block th:replace="baza :: menu"></th:block>

<div class="content1">
  <!-- Основное содержимое главы -->

  <br><br><br>
  <div class="nameAndChapters">
    <div class="onlyNameAndChapters">
      <!-- Ссылка «назад к описанию тайтла» -->
      <a th:href="@{/titles/{nazvanie}(nazvanie=${nazvanie})}">
        <h2 th:text="${titleName}">Название тайтла</h2>
      </a>
      <button id="toggleButton">&#9776;</button>
    </div>
    <div id="sidebarGlavi">
      <div class="sidebar-header">
        <span>Оглавление</span>
        <button id="closeButton">&times;</button>
      </div>
      <ul>
        <!-- Перебираем список глав -->
        <th:block th:each="glava : ${glavi}">
          <th:block th:if="${#strings.contains(glava.glavaName, 'Глава')}">
            <th:block th:if="${curGlava == glava.glavaName}">
              <a th:href="@{/titles/{nazvanie}/{nomerGlavi}(
                          nazvanie=${nazvanie},
                          nomerGlavi=${glava.nomerGlavi})}">
                <li style="background-color:#f0f0f0" th:text="${glava.glavaName}">
                  <th:block th:if="${readedChapters}">
                    <th:block th:each="r : ${readedChapters}">
                      <th:block th:if="${r == glava.nomerGlavi}"> &#10004;</th:block>
                    </th:block>
                  </th:block>
                </li>
              </a>
            </th:block>
            <th:block th:unless="${curGlava == glava.glavaName}">
              <a th:href="@{/titles/{nazvanie}/{nomerGlavi}(
                          nazvanie=${nazvanie},
                          nomerGlavi=${glava.nomerGlavi})}">
                <li th:text="${glava.glavaName}">
                  <th:block th:if="${readedChapters}">
                    <th:block th:each="r : ${readedChapters}">
                      <th:block th:if="${r == glava.nomerGlavi}"> &#10004;</th:block>
                    </th:block>
                  </th:block>
                </li>
              </a>
            </th:block>
          </th:block>
          <th:block th:unless="${#strings.contains(glava.glavaName, 'Глава')}">
            <th:block th:if="${curGlava == glava.glavaName}">
              <a th:href="@{/titles/{nazvanie}/{nomerGlavi}(
                          nazvanie=${nazvanie},
                          nomerGlavi=${glava.nomerGlavi})}">
                <li style="background-color:#f0f0f0">
                  <i th:text="${glava.glavaName}"></i>
                  <th:block th:if="${readedChapters}">
                    <th:block th:each="r : ${readedChapters}">
                      <th:block th:if="${r == glava.nomerGlavi}"> &#10004;</th:block>
                    </th:block>
                  </th:block>
                </li>
              </a>
            </th:block>
            <th:block th:unless="${curGlava == glava.glavaName}">
              <a th:href="@{/titles/{nazvanie}/{nomerGlavi}(
                          nazvanie=${nazvanie},
                          nomerGlavi=${glava.nomerGlavi})}">
                <li>
                  <i th:text="${glava.glavaName}"></i>
                  <th:block th:if="${readedChapters}">
                    <th:block th:each="r : ${readedChapters}">
                      <th:block th:if="${r == glava.nomerGlavi}"> &#10004;</th:block>
                    </th:block>
                  </th:block>
                </li>
              </a>
            </th:block>
          </th:block>
        </th:block>
      </ul>

      <br><br><br>
    </div>
  </div>

  <div id="carouselExampleControls" class="carousel slide" data-ride="carousel" data-interval="false" style="max-width: 90%; margin: 0 auto;">
    <div class="carousel-inner">
      <!-- Первая страница -->
      <div class="carousel-item active">
        <img class="d-block mx-auto" style="max-height: 1200px;" th:src="${pages[0]}" alt="First slide">
      </div>

      <!-- Остальные страницы -->
      <div class="carousel-item" th:each="page, iterStat : ${pages}" th:if="${iterStat.index > 0}">
        <img class="d-block mx-auto" style="max-height: 1200px;" th:src="${page}" alt="Slide">
      </div>
    </div>

    <!-- Управление каруселью -->
    <a class="carousel-control-prev" href="#carouselExampleControls" role="button" data-slide="prev" style="width: 50%;">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="sr-only">Previous</span>
    </a>
    <a class="carousel-control-next" href="#carouselExampleControls" role="button" data-slide="next" style="width: 50%;">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="sr-only">Next</span>
    </a>
  </div>

  <!-- Выбор страницы -->
  <div class="text-center mt-3">
    <label for="pageSelect">Выберите страницу:</label>
    <select id="pageSelect" class="form-control w-25 mx-auto">
      <option value="0">Страница 1</option>
      <option th:each="page, iterStat : ${pages}" th:value="${iterStat.index}" th:text="'Страница ' + (${iterStat.index + 1})"></option>
    </select>
  </div>
</div>

  <!-- Кнопки «предыдущая» / «следующая» глава -->
  <div style="display: flex; justify-content: space-evenly;">
    <!-- Показываем «предыдущая» только если nomer > 1 -->
    <a th:if="${nomer} > 1"
       th:href="@{/titles/{nazvanie}/{prev}(
                   nazvanie=${nazvanie},
                   prev=${nomer-1})}">
      <div class="prevGlava">
        <b>Предыдущая глава</b>
      </div>
    </a>

    <!-- Прячем, если nomer == lastGlava (можно просто не выводить) -->
    <a th:if="${nomer} < ${lastGlava}"
       th:href="@{/titles/{nazvanie}/{next}(
                   nazvanie=${nazvanie},
                   next=${nomer+1})}">
      <div class="nextGlava1">
        <b>Следующая глава</b>
      </div>
    </a>
  </div>

  <!-- Блок комментариев -->
<!-- Блок комментариев -->
<!-- Блок комментариев -->

<!-- Блок комментариев -->
<section class="content-item" id="comments">
  <div class="container">
    <div class="row">
      <div class="col-sm-8">
        <!-- Форма для добавления нового комментария -->
        <form method="post" th:action="@{/titles/{nazvanie}/{nomer}/comment(
                                             nazvanie=${nazvanie},
                                             nomer=${nomer})}">
          <h3 class="pull-left">Новый коммент</h3>
          <fieldset>
            <div class="row">
              <div class="col-sm-3 col-lg-2 hidden-xs">
                <!-- Аватар текущего пользователя -->
                <img class="user_pfp"
                     th:src="${currentUser.profilePic != null} ? @{/${currentUser.profilePic}} : @{/uploads/defaultAvatar.png}"
                     alt="avatar">
              </div>
              <div class="form-group col-xs-12 col-sm-9 col-lg-10">
                    <textarea class="form-control" id="message" name="comment_input"
                              placeholder="Ваш коммент"
                              style="resize:none;overflow-y:hidden"
                              required></textarea>
              </div>
            </div>
          </fieldset>
          <button type="submit" class="btn btn-normal pull-right">Отправить</button>
        </form>

        <!-- Список уже существующих комментариев -->
        <div th:if="${comments != null}">
          <h3 th:text="${#lists.size(comments)} + ' коммента'">0 комментов</h3>
          <th:block th:each="c : ${comments}">
            <!-- c: [username, profilePic, commentText, commentDate, commentId], например -->
            <div class="media">
              <a class="pull-left"
                 th:href="@{/users/{username}(username=${c[0]})}">
                <img class="media-object"
                     th:src="${#strings.isEmpty(c[1]) ? '/uploads/defaultAvatar.png' : '/' + #strings.substringAfter(c[1], 'static\')}"
                     alt="profilePic"/>

              </a>
              <div class="media-body">
                <h4 class="media-heading" th:text="${c[0]}">username</h4>
                <!-- c[2] = commentText -->
                <p th:utext="${c[2]}">Текст</p>
                <ul class="list-unstyled list-inline media-detail pull-left">
                  <li><i class="fa fa-calendar"></i>
                    <span th:text="${c[3]}">дата</span>
                  </li>
                </ul>

                <!-- Показываем кнопку «Удалить» только если
                     currentUser.username == c[0] или currentUser.status=='Админ' -->
                <sec:authorize access="(#authentication.name == c[0]) or hasAuthority('Админ')">
                  <button style="color: red; border:none; background-color:inherit"
                          class="deleteBtn pull-right"
                          th:attr="data-comment-id=${c[4]}">
                    Удалить
                  </button>
                </sec:authorize>
              </div>
            </div>
          </th:block>
        </div>
      </div>
    </div>
  </div>
</section>

</div><!-- content1 -->

<!-- Подключаем общий подвал -->
<th:block th:replace="baza :: footer"></th:block>

<!-- Подключаем скрипты -->
<th:block th:replace="baza :: scripts"></th:block>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const pageSelect = document.getElementById('pageSelect');
    const carousel = $('#carouselExampleControls');

    // Переключение слайдера по выбору страницы
    pageSelect.addEventListener('change', function () {
      const selectedIndex = parseInt(this.value, 10);
      carousel.carousel(selectedIndex);
    });

    // Синхронизация выбора страницы при переключении слайда
    carousel.on('slid.bs.carousel', function () {
      const activeIndex = $(this).find('.carousel-item.active').index();
      pageSelect.selectedIndex = activeIndex;
    });
  });
</script>
<script>
  // Пример того же кода, что у вас был в Jinja2
  // для смены страницы карусели и т.п.

  // Здесь можно делать fetch POST на /delete_comment
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.deleteBtn').forEach(function(button) {
      button.addEventListener('click', function() {
        let commentId = this.getAttribute('data-comment-id');
        fetch('/delete_comment', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ comment_id: commentId })
        }).then((resp) => {
          // например, перезагрузить страницу
          window.location.reload();
        });
      });
    });
  });

  // Открытие/закрытие блока оглавления
  const toggleButton = document.getElementById('toggleButton');
  const closeButton = document.getElementById('closeButton');
  const sidebarGlavi = document.getElementById('sidebarGlavi');

  toggleButton.addEventListener('click', function() {
    sidebarGlavi.style.right = '0';
  });
  closeButton.addEventListener('click', function() {
    sidebarGlavi.style.right = '-100%';
  });

</script>

</body>
</html>
